import request from 'supertest';
import { connectTestDB, disconnectTestDB, clearTestDB } from '../../helpers/mockDatabase.js';
import { createTestAdmin } from '../../helpers/authHelpers.js';
import { createTestBooks } from '../../helpers/factories.js';
import app from '../../../server.js';

describe('Books Integration Tests', () => {
  beforeAll(async () => {
    await connectTestDB();
  });

  afterAll(async () => {
    await disconnectTestDB();
  });

  beforeEach(async () => {
    await clearTestDB();
  });

  describe('GET /api/books', () => {
    beforeEach(async () => {
      await createTestBooks(10);
    });

    it('should get all books', async () => {
      const response = await request(app).get('/api/books').expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data.books).toHaveLength(10);
      expect(response.body.data.total).toBe(10);
    });

    it('should filter books by category', async () => {
      const response = await request(app).get('/api/books?category=Fiction').expect(200);

      expect(response.body.success).toBe(true);
      response.body.data.books.forEach((book) => {
        expect(book.category).toBe('Fiction');
      });
    });

    it('should filter books by language', async () => {
      const response = await request(app).get('/api/books?language=Odia').expect(200);

      expect(response.body.success).toBe(true);
      response.body.data.books.forEach((book) => {
        expect(book.language).toBe('Odia');
      });
    });

    it('should search books by title', async () => {
      const response = await request(app).get('/api/books?search=Book 1').expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data.books.length).toBeGreaterThan(0);
    });

    it('should paginate results', async () => {
      const page1 = await request(app).get('/api/books?page=1&limit=5').expect(200);

      const page2 = await request(app).get('/api/books?page=2&limit=5').expect(200);

      expect(page1.body.data.books).toHaveLength(5);
      expect(page2.body.data.books).toHaveLength(5);
      expect(page1.body.data.page).toBe(1);
      expect(page2.body.data.page).toBe(2);
    });

    it('should sort books by price', async () => {
      const response = await request(app).get('/api/books?sort=price').expect(200);

      const { books } = response.body.data;
      for (let i = 0; i < books.length - 1; i += 1) {
        expect(books[i].price).toBeLessThanOrEqual(books[i + 1].price);
      }
    });
  });

  describe('GET /api/books/:id', () => {
    it('should get a book by ID', async () => {
      const books = await createTestBooks(1);
      const bookId = books[0]._id.toString();

      const response = await request(app).get(`/api/books/${bookId}`).expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data.title).toBe(books[0].title);
    });

    it('should return 404 for non-existent book', async () => {
      const fakeId = '507f1f77bcf86cd799439011';

      const response = await request(app).get(`/api/books/${fakeId}`).expect(404);

      expect(response.body.success).toBe(false);
    });

    it('should return 400 for invalid book ID', async () => {
      const response = await request(app).get('/api/books/invalid-id').expect(400);

      expect(response.body.success).toBe(false);
    });
  });

  describe('POST /api/books (admin only)', () => {
    let adminToken;

    beforeEach(async () => {
      const admin = await createTestAdmin();
      adminToken = admin.token;
    });

    it('should create a new book as admin', async () => {
      const bookData = {
        title: 'New Integration Test Book',
        author: 'Test Author',
        description: 'A test book',
        price: 399,
        category: 'Fiction',
        language: 'Odia',
        publisher: 'Test Publisher',
        isbn: '9780999999999',
        pages: 300,
        stock: 15,
      };

      const response = await request(app)
        .post('/api/books')
        .set('Authorization', `Bearer ${adminToken}`)
        .send(bookData)
        .expect(201);

      expect(response.body.success).toBe(true);
      expect(response.body.data.title).toBe(bookData.title);
      expect(response.body.data.price).toBe(bookData.price);
    });

    it('should return 401 without authentication', async () => {
      const bookData = {
        title: 'Unauthorized Book',
        author: 'Author',
        price: 299,
      };

      const response = await request(app).post('/api/books').send(bookData).expect(401);

      expect(response.body.success).toBe(false);
    });

    it('should return 400 for invalid data', async () => {
      const invalidData = {
        title: 'Book without required fields',
      };

      const response = await request(app)
        .post('/api/books')
        .set('Authorization', `Bearer ${adminToken}`)
        .send(invalidData)
        .expect(400);

      expect(response.body.success).toBe(false);
    });
  });

  describe('PUT /api/books/:id (admin only)', () => {
    let adminToken;
    let testBookId;

    beforeEach(async () => {
      const admin = await createTestAdmin();
      adminToken = admin.token;
      const books = await createTestBooks(1);
      testBookId = books[0]._id.toString();
    });

    it('should update book as admin', async () => {
      const updateData = {
        price: 499,
        stock: 25,
      };

      const response = await request(app)
        .put(`/api/books/${testBookId}`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send(updateData)
        .expect(200);

      expect(response.body.success).toBe(true);
      expect(response.body.data.price).toBe(499);
      expect(response.body.data.stock).toBe(25);
    });

    it('should return 404 for non-existent book', async () => {
      const fakeId = '507f1f77bcf86cd799439011';

      const response = await request(app)
        .put(`/api/books/${fakeId}`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send({ price: 399 })
        .expect(404);

      expect(response.body.success).toBe(false);
    });
  });

  describe('DELETE /api/books/:id (admin only)', () => {
    let adminToken;
    let testBookId;

    beforeEach(async () => {
      const admin = await createTestAdmin();
      adminToken = admin.token;
      const books = await createTestBooks(1);
      testBookId = books[0]._id.toString();
    });

    it('should delete book as admin', async () => {
      const response = await request(app)
        .delete(`/api/books/${testBookId}`)
        .set('Authorization', `Bearer ${adminToken}`)
        .expect(200);

      expect(response.body.success).toBe(true);

      // Verify book is deleted
      await request(app).get(`/api/books/${testBookId}`).expect(404);
    });

    it('should return 404 for non-existent book', async () => {
      const fakeId = '507f1f77bcf86cd799439011';

      const response = await request(app)
        .delete(`/api/books/${fakeId}`)
        .set('Authorization', `Bearer ${adminToken}`)
        .expect(404);

      expect(response.body.success).toBe(false);
    });
  });
});
